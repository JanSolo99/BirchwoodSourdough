<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Test - Bread Preorder</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #output {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            white-space: pre-wrap;
        }
        .available { color: green; }
        .unavailable { color: red; }
        .debug-output {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>Bread Preorder App - Debug Test</h1>
    
    <div class="test-section">
        <h2>1. Test Calendar Picker</h2>
        <div class="form-group">
            <label for="testDate">Select Pickup Date (Tuesday, Wednesday, Thursday only):</label>
            <input type="text" id="testDate" placeholder="Click to select date..." readonly>
        </div>
        <div id="selectedDateOutput"></div>
    </div>

    <div class="test-section">
        <h2>2. Test Stock API</h2>
        <div class="form-group">
            <label for="stockDate">Enter date to check stock (YYYY-MM-DD):</label>
            <input type="text" id="stockDate" placeholder="2025-08-06">
        </div>
        <button onclick="testStockAPI()">Check Stock</button>
        <button onclick="debugStockAPI()">Debug Stock API</button>
        <div id="stockOutput"></div>
    </div>

    <div class="test-section">
        <h2>3. Test Order Creation</h2>
        <div class="form-group">
            <label for="customerName">Customer Name:</label>
            <input type="text" id="customerName" value="Test Customer">
        </div>
        <div class="form-group">
            <label for="contactInfo">Contact Info:</label>
            <input type="text" id="contactInfo" value="test@example.com">
        </div>
        <div class="form-group">
            <label for="orderDate">Pickup Date:</label>
            <input type="text" id="orderDate" placeholder="2025-08-06">
        </div>
        <div class="form-group">
            <label for="numLoaves">Number of Loaves:</label>
            <select id="numLoaves">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
            </select>
        </div>
        <button onclick="testOrderAPI()">Create Test Order</button>
        <div id="orderOutput"></div>
    </div>

    <div class="test-section">
        <h2>4. Environment Check</h2>
        <button onclick="checkEnvironment()">Check API Endpoints</button>
        <div id="envOutput"></div>
    </div>

    <div id="output"></div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        let selectedDate = null;
        
        // Initialize calendar
        document.addEventListener('DOMContentLoaded', function() {
            flatpickr("#testDate", {
                dateFormat: "Y-m-d",
                minDate: "today",
                enable: [
                    function(date) {
                        return (date.getDay() === 2 || date.getDay() === 3 || date.getDay() === 4);
                    }
                ],
                onChange: function(selectedDates, dateStr, instance) {
                    selectedDate = dateStr;
                    document.getElementById('selectedDateOutput').innerHTML = 
                        `<strong>Selected:</strong> ${dateStr} (${['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'][selectedDates[0].getDay()]})`;
                    
                    // Auto-fill order date
                    document.getElementById('orderDate').value = dateStr;
                }
            });
            
            log('Debug page loaded. Testing Flatpickr integration...');
        });

        function log(message) {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            output.textContent += `[${timestamp}] ${message}\n`;
        }

        async function testStockAPI() {
            const date = document.getElementById('stockDate').value;
            if (!date) {
                alert('Please enter a date');
                return;
            }
            
            log(`Testing stock API for date: ${date}`);
            
            try {
                const response = await fetch(`/.netlify/functions/get-stock?date=${date}`);
                const data = await response.json();
                
                document.getElementById('stockOutput').innerHTML = `
                    <h4>Response (Status: ${response.status}):</h4>
                    <div class="debug-output">${JSON.stringify(data, null, 2)}</div>
                `;
                
                log(`Stock API response: ${JSON.stringify(data)}`);
            } catch (error) {
                log(`Stock API error: ${error.message}`);
                document.getElementById('stockOutput').innerHTML = `<div style="color: red;">Error: ${error.message}</div>`;
            }
        }

        async function debugStockAPI() {
            const date = document.getElementById('stockDate').value;
            if (!date) {
                alert('Please enter a date');
                return;
            }
            
            log(`Testing debug stock API for date: ${date}`);
            
            try {
                const response = await fetch(`/.netlify/functions/debug-stock?date=${date}`);
                const data = await response.json();
                
                document.getElementById('stockOutput').innerHTML = `
                    <h4>Debug Response (Status: ${response.status}):</h4>
                    <div class="debug-output">${JSON.stringify(data, null, 2)}</div>
                `;
                
                log(`Debug API response: ${JSON.stringify(data)}`);
            } catch (error) {
                log(`Debug API error: ${error.message}`);
                document.getElementById('stockOutput').innerHTML = `<div style="color: red;">Error: ${error.message}</div>`;
            }
        }

        async function testOrderAPI() {
            const orderData = {
                customerName: document.getElementById('customerName').value,
                contactInfo: document.getElementById('contactInfo').value,
                pickupDay: document.getElementById('orderDate').value,
                numLoaves: parseInt(document.getElementById('numLoaves').value)
            };
            
            if (!orderData.customerName || !orderData.contactInfo || !orderData.pickupDay) {
                alert('Please fill all fields');
                return;
            }
            
            log(`Testing order API with data: ${JSON.stringify(orderData)}`);
            
            try {
                const response = await fetch('/.netlify/functions/create-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });
                
                const data = await response.json();
                
                document.getElementById('orderOutput').innerHTML = `
                    <h4>Response (Status: ${response.status}):</h4>
                    <div class="debug-output">${JSON.stringify(data, null, 2)}</div>
                `;
                
                log(`Order API response: ${JSON.stringify(data)}`);
            } catch (error) {
                log(`Order API error: ${error.message}`);
                document.getElementById('orderOutput').innerHTML = `<div style="color: red;">Error: ${error.message}</div>`;
            }
        }

        async function checkEnvironment() {
            log('Checking environment and API endpoints...');
            
            const checks = [
                { name: 'Flatpickr Library', test: () => typeof flatpickr !== 'undefined' },
                { name: 'Fetch API', test: () => typeof fetch !== 'undefined' },
                { name: 'Date Selection', test: () => selectedDate !== null }
            ];
            
            let results = '<h4>Environment Check Results:</h4><ul>';
            
            checks.forEach(check => {
                const passed = check.test();
                results += `<li style="color: ${passed ? 'green' : 'red'}">${check.name}: ${passed ? 'PASS' : 'FAIL'}</li>`;
                log(`${check.name}: ${passed ? 'PASS' : 'FAIL'}`);
            });
            
            results += '</ul>';
            
            // Test API endpoints availability
            results += '<h4>API Endpoint Tests:</h4><ul>';
            
            try {
                const stockResponse = await fetch('/.netlify/functions/get-stock?date=2025-08-06');
                results += `<li style="color: ${stockResponse.ok ? 'green' : 'orange'}">Stock API: ${stockResponse.status} ${stockResponse.statusText}</li>`;
                log(`Stock API endpoint: ${stockResponse.status} ${stockResponse.statusText}`);
            } catch (error) {
                results += `<li style="color: red">Stock API: Error - ${error.message}</li>`;
                log(`Stock API endpoint error: ${error.message}`);
            }
            
            try {
                const debugResponse = await fetch('/.netlify/functions/debug-stock?date=2025-08-06');
                results += `<li style="color: ${debugResponse.ok ? 'green' : 'orange'}">Debug API: ${debugResponse.status} ${debugResponse.statusText}</li>`;
                log(`Debug API endpoint: ${debugResponse.status} ${debugResponse.statusText}`);
            } catch (error) {
                results += `<li style="color: red">Debug API: Error - ${error.message}</li>`;
                log(`Debug API endpoint error: ${error.message}`);
            }
            
            results += '</ul>';
            document.getElementById('envOutput').innerHTML = results;
        }
    </script>
</body>
</html>